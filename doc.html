<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physician Page</title>
    <link rel="stylesheet" href="doc.css">
    <link rel="shortcut icon" href="download.jpeg">
</head>
<body>
    <h1>Welcome, Medical Staff</h1>
    <br>
    <p>This is your dashboard.</p>
    <br>
    <div class="Info">
        <p id="name">Physician's Name:</p>
        <p id="userID">UserID:</p>
        <p id="E-mail">E-mail:</p>
        <p id="MS">Medical Specialization:</p>
    </div>
    <div class="Patients">
        <span id="arrow1">&#9660;</span>
        <label for="patient-search"><b>Your Patients</b></label>
        <input type="text" name="patientName" id="patientName" placeholder="Search by User ID">
    </div>
    <div class="patients-table" id="patientsTable" style="display: none;">
        <table border="2">
            <thead>
                <tr>
                    <th>User_ID</th>
                    <th>Gender</th>
                    <th>Contact</th>
                    <th>Chronic_Conditions</th>
                    <th>Purpose_of_Visit</th>
                    <th>Prescribing_Doctor_ID</th>
                    <th>Allergies</th>
                    <th>Medication</th>
                    <th>Dosage</th>
                    <th>Edit/Delete</th>
                </tr>
            </thead>
            <tbody id="patientsTableBody"></tbody>
        </table>
    </div>
    <br>
    <button id="addPatientButton" onclick="window.location.href='doc_add_patient.html'">Add Patient</button>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const doctorId = localStorage.getItem('user_id');
            if (doctorId) {
                document.getElementById('prescribingDoctorID').value = doctorId;
            } else {
                console.error('Doctor ID not found in localStorage.');
            }
        });
        
        async function submitPatient() {
            const doctorId = localStorage.getItem('user_id'); // grab again here too
        
            const formData = {
                User_ID: document.getElementById('userID').value,
                Patient_ID_Clinical: document.getElementById('patientClinicalID').value,
                Patient_ID_Billing: document.getElementById('patientBillingID').value,
                Gender: document.getElementById('patientGender').value,
                Contact: document.getElementById('patientContact').value,
                Allergies: document.getElementById('allergies').value,
                Chronic_Conditions: document.getElementById('chronicConditions').value,
                Purpose_of_Visit: document.getElementById('purposeOfVisit').value,
                Prescribing_Doctor_ID: doctorId,  // use the constant doctorId here
            };
        
            try {
                const response = await fetch('https://sylvia560githubio-production-0677.up.railway.app/patients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });
        
                if (response.ok) {
                    alert('Patient added successfully!');
                    document.getElementById('patientForm').reset();
                    document.getElementById('prescribingDoctorID').value = doctorId; // refill the doctor ID after reset
                } else {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.detail}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while submitting the form.');
            }
        }
        </script>
</body>
</html>