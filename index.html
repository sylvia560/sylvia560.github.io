<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <link rel="stylesheet" href="try_styles.css">
</head>
  <body>
    <div class="container">
        <h1>Login</h1>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
            </div>
            <p class="forget-pass"><a href="ForgetPass.html">Forget Password?</a></p>
            <button type="submit" class="btn">Send OTP</button>
          </form>
            <div id="step2" style="display: none; margin-top: 15px;">
                <input type="text" id="otp" placeholder="Enter OTP">
                <button type="button" class="btn" onclick="verifyOTP()">Login</button>
            </div>
            <p class="redirect">Don't have an account? <a href="try_signup.html">Sign Up</a></p>
        
        <p id="message"></p>
        <div id="result"></div>
    </div>
    <script>
      // Utility Functions
      function getLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve(position),
                        (error) => reject(error)
                    );
                } else {
                    reject(new Error("Geolocation is not supported by this browser."));
                }
            });
        }
      async function getIPLocation() {
          try {
              const response = await fetch('https://ipapi.co/json/');
              const data = await response.json();
              return { coords: { latitude: data.latitude, longitude: data.longitude } };
          } catch {
              return null;
          }
      }
  
      function getOS() {
          const appVersion = navigator.appVersion;
          if (appVersion.indexOf("Win") !== -1) return "Windows";
          if (appVersion.indexOf("Mac") !== -1) return "MacOS";
          if (appVersion.indexOf("X11") !== -1) return "UNIX";
          if (appVersion.indexOf("Linux") !== -1) return "Linux";
          return "Unknown OS";
      }
  
      function getBrowser() {
          const ua = navigator.userAgent;
          if (/edg/i.test(ua)) return "Edge";
          if (/opr\//i.test(ua)) return "Opera";
          if (/chrome|chromium|crios/i.test(ua)) return "Chrome";
          if (/firefox|fxios/i.test(ua)) return "Firefox";
          if (/safari/i.test(ua) && !/chrome|crios|edg|opr|fxios/i.test(ua)) return "Safari";
          return "Unknown Browser";
      }
  
      // Event: Login Form Submit
      document.getElementById('login-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const username = formData.get('username'); // Should match the backend's expected field
        const password = formData.get('password');

        console.log("Submitting:", { username, password }); // Debug log
  
          try {
              const position = await getLocation();
              const location = `${position.coords.latitude},${position.coords.longitude}`;
              const os = getOS();
              const browser = getBrowser();
  
              const requestBody = new URLSearchParams({
                    username: username,
                    password: password,
                    current_location: location,
                    os: os,
                    browser: browser
                }).toString();
                console.log("Request body:", requestBody); // Debugging log;
  
              // Step 1: Initial auth (without token)
              const response = await fetch('https://sylvia560githubio-production.up.railway.app/auth', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                  body: requestBody
              });
  
              const result = await response.json();
              if (!response.ok) throw new Error(result.detail || "Login failed");
  
              // Store email and role for OTP verification
              localStorage.setItem('email', username);
              localStorage.setItem('password', password);  // Temporarily store password for later token request
              localStorage.setItem('role', result.Role || 'Unknown');
  
              await sendOTP(); // Proceed to OTP step
          } catch (err) {
              console.error(err);
              alert('Login failed. Check credentials.');
          }
      });
  
      // Function: Send OTP
      async function sendOTP() {
          const email = localStorage.getItem('email');
          const response = await fetch(`https://sylvia560githubio-production.up.railway.app/send-otp`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email })
          });
  
          const result = await response.json();
          document.getElementById("message").innerText = result.message;
  
          if (response.ok) {
              document.getElementById("step2").style.display = "block";
              document.getElementById("otp").required = true;
          }
      }
  
      // Function: Verify OTP and request token
      async function verifyOTP() {
          const email = localStorage.getItem('email');
          const password = localStorage.getItem('password');
          const role = localStorage.getItem('role');
          const otp = document.getElementById("otp").value;
  
          const otpResponse = await fetch(`https://sylvia560githubio-production.up.railway.app/verify-otp`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, otp })
          });
  
          const otpResult = await otpResponse.json();
          document.getElementById("message").innerText = otpResult.message;
  
          if (otpResult.message === "OTP verified successfully!") {
              const position = await getLocation();
              const location = `${position.coords.latitude},${position.coords.longitude}`;
              const os = getOS();
              const browser = getBrowser();
  
              const loginBody = new URLSearchParams({
                  username: email,
                  password: password,
                  current_location: location,
                  os,
                  browser
              });
  
              const tokenResponse = await fetch('https://sylvia560githubio-production-0677.up.railway.app/auth/login', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                  body: loginBody.toString()
              });
  
              const tokenData = await tokenResponse.json();
              if (!tokenResponse.ok) throw new Error(tokenData.detail || "Failed to get token");
  
              // Store token data
              localStorage.setItem('access_token', tokenData.access_token);
              localStorage.setItem('refresh_token', tokenData.refresh_token);
              localStorage.setItem('user_id', tokenData.user_id);
              localStorage.setItem('access_token_expires', tokenData.access_token_expires);
              localStorage.setItem('refresh_token_expires', tokenData.refresh_token_expires);
              localStorage.setItem('user_info', tokenData.user_info);
  
              alert("OTP Verified. Redirecting...");
              if (role === 'Doctor') window.location.href = 'doc.html';
              else if (role === 'Patient' || role === 'Client') window.location.href = 'patient.html';
              else alert(`You are ${role}. No dashboard configured.`);
          } else {
              alert("OTP verification failed.");
          }
      }
  
      // Optional: Refresh token mechanism
      async function refreshAccessToken() {
          const refreshToken = localStorage.getItem('refresh_token');
          if (!refreshToken) return null;
  
          try {
              const position = await getLocation();
              const location = `${position.coords.latitude},${position.coords.longitude}`;
              const os = getOS();
              const browser = getBrowser();
  
              const body = new URLSearchParams({
                  refresh_token: refreshToken,
                  current_location: location,
                  os,
                  browser
              });
  
              const response = await fetch('https://sylvia560githubio-production-0677.up.railway.app/auth/refresh', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                  body: body.toString()
              });
  
              const data = await response.json();
              if (!response.ok) throw new Error("Token refresh failed");
  
              localStorage.setItem('access_token', data.access_token);
              localStorage.setItem('refresh_token', data.refresh_token);
              localStorage.setItem('access_token_expires', data.access_token_expires);
              localStorage.setItem('refresh_token_expires', data.refresh_token_expires);
              localStorage.setItem('user_info', data.user_info);
  
              return data.access_token;
          } catch (err) {
              localStorage.clear();
              window.location.href = 'index.html';
          }
      }
  
      async function checkTokenExpiration() {
          const expires = localStorage.getItem('access_token_expires');
          if (!expires) return;
  
          const now = Math.floor(Date.now() / 1000);
          if (now >= expires) await refreshAccessToken();
      }
  
      window.addEventListener('load', checkTokenExpiration);
    </script>
  
  </body>
</html>